---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: wger
  labels:
    app: wger
spec:
  replicas: 1
  selector:
    matchLabels:
      app: wger
  template:
    metadata:
      labels:
        app: wger
    spec:
      initContainers:
      - name: collectstatic
        image: wger/server:2.4-dev
        command: ["python3", "manage.py", "collectstatic", "--noinput"]
        volumeMounts:
          - name: static-files
            mountPath: /home/wger/static
        env:
          # Minimal env vars needed for collectstatic
          - name: "SECRET_KEY"
            value: "collectstatic-temporary-key"
          - name: "SIGNING_KEY"
            value: "collectstatic-temporary-signing-key"

      containers:
      - name: wger
        image: wger/server:2.4-dev
        env:
          # Application settings
          - name: "SITE_URL"
            value: "https://wger.internal"
          - name: "TIME_ZONE"
            value: "America/New_York"
          - name: "TZ"
            value: "America/New_York"
          - name: "LANGUAGE_CODE"
            value: "en-us"
          - name: "ALLOW_REGISTRATION"
            value: "true"
          - name: "ALLOW_GUEST_USERS"
            value: "false"

          # Use Gunicorn instead of Django dev server
          - name: "WGER_USE_GUNICORN"
            value: "True"

          # CSRF and proxy settings
          - name: "CSRF_TRUSTED_ORIGINS"
            value: "https://wger.internal"
          - name: "X_FORWARDED_PROTO_HEADER_SET"
            value: "True"

          # Static and media files
          - name: "MEDIA_URL"
            value: "https://wger.internal/media/"
          - name: "STATIC_URL"
            value: "https://wger.internal/static/"

          # Database configuration
          - name: "DJANGO_DB_ENGINE"
            value: "django.db.backends.postgresql"
          - name: "DJANGO_DB_DATABASE"
            valueFrom:
              secretKeyRef:
                name: wger-16-db-app
                key: dbname
          - name: "DJANGO_DB_USER"
            valueFrom:
              secretKeyRef:
                name: wger-16-db-app
                key: username
          - name: "DJANGO_DB_PASSWORD"
            valueFrom:
              secretKeyRef:
                name: wger-16-db-app
                key: password
          - name: "DJANGO_DB_HOST"
            valueFrom:
              secretKeyRef:
                name: wger-16-db-app
                key: host
          - name: "DJANGO_DB_PORT"
            valueFrom:
              secretKeyRef:
                name: wger-16-db-app
                key: port
          - name: "DJANGO_PERFORM_MIGRATIONS"
            value: "true"

          # Redis/Cache configuration
          - name: "DJANGO_CACHE_BACKEND"
            value: "django_redis.cache.RedisCache"
          - name: "DJANGO_CACHE_LOCATION"
            value: "redis://wger-redis:6379/1"
          - name: "DJANGO_CACHE_CLIENT_CLASS"
            value: "django_redis.client.DefaultClient"
          - name: "DJANGO_CACHE_TIMEOUT"
            value: "1296000"  # 15 days

          # Celery configuration
          - name: "USE_CELERY"
            value: "true"
          - name: "CELERY_BROKER"
            value: "redis://wger-redis:6379/2"
          - name: "CELERY_BACKEND"
            value: "redis://wger-redis:6379/2"

          # Security keys (from secret)
          - name: "SECRET_KEY"
            valueFrom:
              secretKeyRef:
                name: wger-secrets
                key: secret-key
          - name: "SIGNING_KEY"
            valueFrom:
              secretKeyRef:
                name: wger-secrets
                key: signing-key

          # JWT token lifetimes
          - name: "ACCESS_TOKEN_LIFETIME"
            value: "10"  # 10 minutes
          - name: "REFRESH_TOKEN_LIFETIME"
            value: "24"  # 24 hours

          # Axes (brute force protection)
          - name: "AXES_ENABLED"
            value: "true"
          - name: "AXES_FAILURE_LIMIT"
            value: "10"

          # Remote wger instance for syncing exercises
          - name: "WGER_INSTANCE"
            value: "https://wger.de"

        ports:
          - containerPort: 8000
            name: http-wger

        volumeMounts:
          - name: static-files
            mountPath: /home/wger/static
          - name: media-files
            mountPath: /home/wger/media

        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 1Gi

        livenessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 60
          periodSeconds: 30
          timeoutSeconds: 5

        readinessProbe:
          httpGet:
            path: /
            port: 8000
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5

      - name: nginx
        image: nginx:1.29-alpine
        ports:
          - containerPort: 80
            name: http

        volumeMounts:
          - name: nginx-config
            mountPath: /etc/nginx/conf.d/default.conf
            subPath: nginx.conf
          - name: static-files
            mountPath: /wger/static
            readOnly: true
          - name: media-files
            mountPath: /wger/media
            readOnly: true

        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            memory: 128Mi

        livenessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 10
          periodSeconds: 10

        readinessProbe:
          httpGet:
            path: /
            port: 80
          initialDelaySeconds: 5
          periodSeconds: 5

      volumes:
        - name: nginx-config
          configMap:
            name: wger-nginx-config
        - name: static-files
          emptyDir: {}
        - name: media-files
          emptyDir: {}
